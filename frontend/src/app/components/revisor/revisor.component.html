<!-- revisor.component.html - VERSIÃ“N COMPLETA CORREGIDA -->
<div class="revisor-container">
  <div class="revisor-card">
    <!-- Header -->
    <div class="card-header">
      <div class="header-content">
        <div class="icon-wrapper">
          <span class="revisor-icon">ğŸ‘¥</span>
        </div>
        <div class="header-text">
          <h2>Panel de RevisiÃ³n de Documentos</h2>
          <p class="subtitle">Sistema de Pool Colaborativo</p>
        </div>
      </div>
      
      <!-- Selector de revisor flotante -->
      <div class="floating-selector">
        <div class="form-group compact">
          <label for="revisorSelect" class="form-label">
            <span class="label-icon">ğŸ‘¤</span>
            Tu Identidad
          </label>
          <select 
            id="revisorSelect"
            [(ngModel)]="revisorName"
            class="form-input select compact"
            [disabled]="poolAbierto && poolOwner === revisorName"
          >
            <option value="" disabled selected>Â¿QuiÃ©n eres?</option>
            <option value="RevisorA">Revisor A</option>
            <option value="RevisorB">Revisor B</option>
            <option value="RevisorC">Revisor C</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Panel de Control del Pool -->
    <div class="pool-control-section" [ngClass]="{'pool-abierto': poolAbierto, 'pool-cerrado': !poolAbierto}">
      <div class="pool-status">
        <div class="pool-indicator">
          <span class="indicator-dot" [ngClass]="{'active': poolAbierto}"></span>
          <span class="indicator-text">
            {{ poolAbierto ? 'POOL ACTIVO' : 'POOL DISPONIBLE' }}
          </span>
        </div>
        
        <!-- Pool Info cuando estÃ¡ activo -->
        <div class="pool-info" *ngIf="poolAbierto">
          <div class="pool-owner">
            <span class="owner-icon">ğŸ‘‘</span>
            <span class="owner-text">
              <strong>{{ poolOwner }}</strong> estÃ¡ usando el pool
              <!-- Badge para pestaÃ±a original -->
              <span *ngIf="poolOwner === revisorName && isOriginalOwner" class="yo-badge-pool">
                (TÃš - PestaÃ±a Original)
              </span>
              <!-- Badge para otra pestaÃ±a del mismo usuario -->
              <span *ngIf="poolOwner === revisorName && !isOriginalOwner" class="yo-badge-secondary">
                (TÃš - Otra PestaÃ±a)
              </span>
            </span>
          </div>
          
          <div class="pool-stats">
            <span class="stat">
              <span class="stat-icon">â±ï¸</span>
              {{ getTiempoTranscurrido() }}
            </span>
            <span class="stat">
              <span class="stat-icon">ğŸ“„</span>
              {{ documentosRevisados }} revisados
            </span>
          </div>
          
          <!-- âœ… MENSAJE ESPECÃFICO: Mismo usuario, otra pestaÃ±a -->
          <div class="pool-warning same-user" *ngIf="poolAbierto && poolOwner === revisorName && !isOriginalOwner">
            <span class="warning-icon">â„¹ï¸</span>
            <span class="warning-text">
              Ya tienes el pool abierto en otra pestaÃ±a. Solo puedes cerrarlo desde la pestaÃ±a original.
            </span>
          </div>
          
          <!-- Mensaje de advertencia si OTRO usuario tiene el pool -->
          <div class="pool-warning" *ngIf="poolAbierto && poolOwner !== revisorName">
            <span class="warning-icon">â³</span>
            <span class="warning-text">
              Espera a que {{ poolOwner }} libere el pool para poder abrirlo
            </span>
          </div>
        </div>
        
        <!-- Pool Info cuando estÃ¡ disponible -->
        <div class="pool-info" *ngIf="!poolAbierto">
          <p class="pool-message">
            <span class="message-icon">ğŸ’¡</span>
            El pool estÃ¡ disponible. SÃ© el primero en abrirlo para revisar documentos
          </p>
        </div>
      </div>
      
      <div class="pool-actions">
        <!-- âœ… BotÃ³n Abrir Pool - solo si no hay pool activo -->
        <button 
          *ngIf="!poolAbierto"
          (click)="abrirPool()"
          class="btn-pool btn-abrir"
          [disabled]="!revisorName || isLoading"
        >
          <span class="btn-icon">ğŸ”“</span>
          Abrir Pool (Solo 1 a la vez)
        </button>
        
        <!-- âœ… BotÃ³n Cerrar Pool - SOLO si es dueÃ±o Y pestaÃ±a original -->
        <button 
          *ngIf="poolAbierto && poolOwner === revisorName && isOriginalOwner"
          (click)="cerrarPool()"
          class="btn-pool btn-cerrar"
          [disabled]="isLoading"
        >
          <span class="btn-icon">ğŸ”’</span>
          Cerrar y Liberar Pool
        </button>
        
        <!-- âœ… MENSAJE INFO: Mismo usuario pero otra pestaÃ±a -->
        <div *ngIf="poolAbierto && poolOwner === revisorName && !isOriginalOwner" class="pool-info-message">
          <span class="info-icon">â„¹ï¸</span>
          Tienes el pool abierto en otra pestaÃ±a
        </div>
        
        <!-- Mensaje si otro tiene el pool -->
        <div *ngIf="poolAbierto && poolOwner !== revisorName" class="pool-ocupado-message">
          <span class="ocupado-icon">ğŸ”´</span>
          Pool ocupado por {{ poolOwner }}
        </div>
        
        <!-- Botones adicionales -->
        <button 
          (click)="cargar()"
          class="btn-pool btn-refresh"
          [disabled]="isLoading"
        >
          <span class="btn-icon" *ngIf="!isLoading">ğŸ”„</span>
          <span class="spinner-small" *ngIf="isLoading"></span>
          {{ isLoading ? 'Cargando...' : 'Actualizar' }}
        </button>
        
        <button 
          (click)="toggleActividades()"
          class="btn-pool btn-actividades"
          [class.active]="showActividades"
        >
          <span class="btn-icon">ğŸ“‹</span>
          Actividades
          <span class="badge-count" *ngIf="actividades.length > 0">
            {{ actividades.length }}
          </span>
        </button>
      </div>
    </div>

    <!-- Panel de Actividades en Tiempo Real -->
    <div class="actividades-panel" *ngIf="showActividades">
      <div class="actividades-header">
        <h3>
          <span class="title-icon">âš¡</span>
          Actividad en Tiempo Real
        </h3>
        <button class="btn-clear" (click)="clearActividades()" *ngIf="actividades.length > 0">
          <span class="btn-icon">ğŸ—‘ï¸</span>
          Limpiar
        </button>
      </div>
      
      <div class="actividades-list" *ngIf="actividades.length > 0">
        <div 
          *ngFor="let act of actividades" 
          class="actividad-item"
          [ngClass]="{'propia': act.tipo === 'propia', 'otro': act.tipo === 'otro', 'sistema': act.tipo === 'sistema'}"
        >
          <span class="actividad-icon">{{ act.icono }}</span>
          <span class="actividad-text">{{ act.texto }}</span>
          <span class="actividad-time">
            {{ act.fecha | date:'HH:mm:ss' }}
          </span>
        </div>
      </div>
      
      <div class="empty-actividades" *ngIf="actividades.length === 0">
        <span class="empty-icon">ğŸ“­</span>
        <p>No hay actividad reciente</p>
        <p class="empty-subtext">Las acciones aparecerÃ¡n aquÃ­ automÃ¡ticamente</p>
      </div>
    </div>

    <!-- Filtros RÃ¡pidos -->
    <div class="filters-section">
      <div class="filters-grid">
        <button 
          class="filter-btn"
          [class.active]="currentFilter === null"
          (click)="cambiarFiltro(null)"
        >
          <span class="filter-icon">ğŸ“‹</span>
          Todos
          <span class="filter-count">{{ documentos.length }}</span>
        </button>
        
        <button 
          class="filter-btn disponible"
          [class.active]="currentFilter === 'DISPONIBLES'"
          (click)="cambiarFiltro('DISPONIBLES')"
        >
          <span class="filter-icon">ğŸ“„</span>
          Disponibles
          <span class="filter-count">{{ contarDisponibles() }}</span>
        </button>
        
        <button 
          class="filter-btn en-revision"
          [class.active]="currentFilter === 'ASIGNADOS'"
          (click)="cambiarFiltro('ASIGNADOS')"
        >
          <span class="filter-icon">ğŸ”</span>
          En RevisiÃ³n
          <span class="filter-count">{{ contarAsignados() }}</span>
        </button>
        
        <button 
          class="filter-btn aceptado"
          [class.active]="currentFilter === 'ACEPTADO'"
          (click)="cambiarFiltro('ACEPTADO')"
        >
          <span class="filter-icon">âœ…</span>
          Aceptados
          <span class="filter-count">{{ contarPorEstado('ACEPTADO') }}</span>
        </button>
        
        <button 
          class="filter-btn rechazado"
          [class.active]="currentFilter === 'RECHAZADO'"
          (click)="cambiarFiltro('RECHAZADO')"
        >
          <span class="filter-icon">âŒ</span>
          Rechazados
          <span class="filter-count">{{ contarPorEstado('RECHAZADO') }}</span>
        </button>
      </div>
    </div>

    <!-- Lista de Documentos -->
    <div class="documents-section">
      <div class="section-header">
        <h3 class="section-title">
          <span class="title-icon">ğŸ“</span>
          Documentos
          <span class="document-count">({{ documentosFiltrados.length }})</span>
        </h3>
        
        <div class="section-info" *ngIf="currentFilter">
          <span class="info-badge">
            {{ 
              currentFilter === 'DISPONIBLES' ? 'ğŸ“„ Disponibles' :
              currentFilter === 'ASIGNADOS' ? 'ğŸ” En RevisiÃ³n' :
              currentFilter === 'ACEPTADO' ? 'âœ… Aceptados' :
              currentFilter === 'RECHAZADO' ? 'âŒ Rechazados' : 'ğŸ“‹ Todos'
            }}
          </span>
          <button class="btn-clear-filter" (click)="cambiarFiltro(null)">
            <span class="btn-icon">âœ•</span>
            Limpiar
          </button>
        </div>
      </div>

      <!-- Estado VacÃ­o -->
      <div class="empty-state" *ngIf="documentosFiltrados.length === 0">
        <div class="empty-icon">
          {{ 
            currentFilter === 'DISPONIBLES' ? 'ğŸ“„' :
            currentFilter === 'ASIGNADOS' ? 'ğŸ”' :
            currentFilter === 'ACEPTADO' ? 'âœ…' :
            currentFilter === 'RECHAZADO' ? 'âŒ' : 'ğŸ“'
          }}
        </div>
        <h4 class="empty-title">
          {{ 
            currentFilter === 'DISPONIBLES' ? 'No hay documentos disponibles' :
            currentFilter === 'ASIGNADOS' ? 'No hay documentos en revisiÃ³n' :
            currentFilter === 'ACEPTADO' ? 'No hay documentos aceptados' :
            currentFilter === 'RECHAZADO' ? 'No hay documentos rechazados' :
            'No hay documentos para revisar'
          }}
        </h4>
        <p class="empty-text">
          {{ 
            currentFilter ? 'Prueba con otro filtro o actualiza la lista' :
            'Los documentos aparecerÃ¡n aquÃ­ cuando sean subidos al sistema'
          }}
        </p>
      </div>

      <!-- Lista de Documentos -->
      <div class="documents-grid" *ngIf="documentosFiltrados.length > 0">
        <div 
          *ngFor="let doc of documentosFiltrados" 
          class="document-card"
          [ngClass]="{
            'disponible': isDocumentAvailable(doc),
            'en-revision': isDocumentAssigned(doc) && !isDocumentFinalized(doc),
            'aceptado': doc.estado === 'ACEPTADO',
            'rechazado': doc.estado === 'RECHAZADO',
            'finalizado': isDocumentFinalized(doc)
          }"
        >
          <div class="card-header">
            <div class="doc-icon">
              <span *ngIf="doc.estado === 'ACEPTADO'">âœ…</span>
              <span *ngIf="doc.estado === 'RECHAZADO'">âŒ</span>
              <span *ngIf="!doc.estado && isDocumentAvailable(doc)">ğŸ“„</span>
              <span *ngIf="!doc.estado && isDocumentAssigned(doc)">ğŸ”</span>
            </div>
            
            <div class="doc-status">
              <span class="status-badge" [ngClass]="getStatusClass(doc.estado)">
                {{ getStatusText(doc.estado) }}
              </span>
              <span class="doc-date">{{ formatDate(doc.fechaSubido || doc.fecha_subido) }}</span>
            </div>
          </div>
          
          <div class="card-body">
            <h4 class="doc-title">{{ doc.nombreArchivo || doc.nombre }}</h4>
            <p class="doc-solicitante">
              <span class="label-icon">ğŸ“§</span>
              {{ doc.solicitanteEmail || doc.solicitante_email }}
            </p>
            
            <div class="doc-meta">
              <span class="meta-item" *ngIf="doc.atendidoPor || doc.reviewer">
                <span class="meta-icon">ğŸ‘¤</span>
                {{ doc.atendidoPor || doc.reviewer }}
                <span *ngIf="(doc.atendidoPor || doc.reviewer) === revisorName" class="yo-badge">TÃº</span>
              </span>
            </div>
          </div>
          
          <div class="card-actions">
            <!-- Acciones de Vista -->
            <div class="view-actions">
              <button 
                (click)="verPDF(doc)"
                class="btn-action btn-view"
                title="Vista previa"
              >
                <span class="action-icon">ğŸ‘ï¸</span>
                Ver
              </button>
              
              <button 
                (click)="descargarPDF(doc)"
                class="btn-action btn-download"
                title="Descargar"
              >
                <span class="action-icon">ğŸ“¥</span>
                Descargar
              </button>
            </div>
            
            <!-- âœ… Acciones de RevisiÃ³n (solo si pool abierto Y es pestaÃ±a original) -->
            <div class="review-actions" *ngIf="puedeControlarPool && !isDocumentFinalized(doc)">
              <button 
                *ngIf="isDocumentAvailable(doc)"
                (click)="tomarDocumento(doc)"
                class="btn-action btn-take"
                title="Tomar para revisar"
              >
                <span class="action-icon">ğŸ‘‹</span>
                Tomar
              </button>
              
              <div class="decision-actions" *ngIf="isDocumentAssigned(doc) && (doc.atendidoPor || doc.reviewer) === revisorName">
                <button 
                  (click)="aceptar(doc)"
                  class="btn-action btn-accept"
                  title="Aceptar documento"
                >
                  <span class="action-icon">âœ“</span>
                  Aceptar
                </button>
                
                <button 
                  (click)="openRejectModal(doc)"
                  class="btn-action btn-reject"
                  title="Rechazar documento"
                >
                  <span class="action-icon">âœ—</span>
                  Rechazar
                </button>
              </div>
            </div>
            
            <!-- Estado Finalizado -->
            <div class="finalized-state" *ngIf="isDocumentFinalized(doc)">
              <span class="finalized-text">
                {{ doc.estado === 'ACEPTADO' ? 'âœ… Aceptado' : 'âŒ Rechazado' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Rechazo Mejorado -->
<div class="modal-overlay" *ngIf="showRejectModal">
  <div class="modal reject-modal">
    <div class="modal-header">
      <div class="modal-icon-header">
        <span class="modal-main-icon">âŒ</span>
        <div class="modal-title-group">
          <h3 class="modal-title">Rechazar Documento</h3>
          <p class="modal-subtitle">Proporciona una razÃ³n para el rechazo</p>
        </div>
      </div>
      <button class="modal-close" (click)="closeRejectModal()">
        <span class="close-icon">Ã—</span>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="doc-summary">
        <div class="summary-item">
          <span class="summary-label">Documento:</span>
          <span class="summary-value">{{ documentoARechazar?.nombreArchivo || documentoARechazar?.nombre }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Solicitante:</span>
          <span class="summary-value">{{ documentoARechazar?.solicitanteEmail || documentoARechazar?.solicitante_email }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Fecha:</span>
          <span class="summary-value">{{ formatDate(documentoARechazar?.fechaSubido || documentoARechazar?.fecha_subido) }}</span>
        </div>
      </div>
      
      <div class="form-group">
        <label for="motivoRechazo" class="form-label">
          <span class="label-icon">ğŸ“</span>
          Motivo del Rechazo
          <span class="required">*</span>
        </label>
        <div class="input-group">
          <textarea 
            id="motivoRechazo"
            [(ngModel)]="motivoRechazo"
            class="form-input textarea"
            rows="4"
            placeholder="Describe el motivo del rechazo de manera clara y constructiva..."
            [class.error]="attemptedReject && !motivoRechazo.trim()"
            autofocus
          ></textarea>
          <div class="char-counter">
            {{ motivoRechazo.length }}/500
          </div>
        </div>
        <div class="error-message" *ngIf="attemptedReject && !motivoRechazo.trim()">
          <span class="error-icon">âš ï¸</span>
          El motivo del rechazo es obligatorio
        </div>
        <div class="form-hint">
          <span class="hint-icon">ğŸ’¡</span>
          Este motivo serÃ¡ visible para el solicitante del documento.
        </div>
      </div>
      
      <div class="suggested-reasons">
        <p class="suggested-title">Motivos comunes:</p>
        <div class="reasons-grid">
          <button 
            *ngFor="let motivo of ['Documento ilegible', 'Falta informaciÃ³n requerida', 'Documento incorrecto', 'Fuera de plazo', 'No cumple requisitos']"
            (click)="motivoRechazo = motivo"
            class="reason-chip"
          >
            {{ motivo }}
          </button>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeRejectModal()">
        <span class="btn-icon">â†</span>
        Cancelar
      </button>
      <button class="btn-primary" (click)="confirmarRechazo()">
        <span class="btn-icon">âœ—</span>
        Confirmar Rechazo
      </button>
    </div>
  </div>
</div>

<!-- Notificaciones Flotantes -->
<div class="notification-container">
  <div class="notification success" *ngIf="showSuccessNotification">
    <div class="notification-icon">âœ…</div>
    <div class="notification-content">
      <p class="notification-title">Â¡Ã‰xito!</p>
      <p class="notification-message">{{ successMessage }}</p>
    </div>
    <button class="notification-close" (click)="showSuccessNotification = false">
      <span class="close-icon">Ã—</span>
    </button>
  </div>
  
  <div class="notification error" *ngIf="showErrorNotification">
    <div class="notification-icon">âŒ</div>
    <div class="notification-content">
      <p class="notification-title">Error</p>
      <p class="notification-message">{{ errorMessage }}</p>
    </div>
    <button class="notification-close" (click)="showErrorNotification = false">
      <span class="close-icon">Ã—</span>
    </button>
  </div>
</div>